package parser

import (
	"fmt"
	"io/ioutil"
	"math/rand"
	"os"
	"time"

	"github.com/google/uuid"
	"github.com/tidwall/sjson"
)

func init() {
    rand.Seed(time.Now().Unix())
}

func GetJsonString(filePath string) string{
    jsonFile, err := os.Open(filePath)
    if err != nil {
        panic(err)
    }
    defer jsonFile.Close()

    byteValue, _ := ioutil.ReadAll(jsonFile)
    jsonString := string(byteValue[:])
    
    return jsonString
}

func GetPreparedJsonForRequest(jsonString string, dynamicfields map[string]string) string  {
    newJSON:= jsonString   

    for key, value := range dynamicfields {
        switch value{
            case "timestamp":
               newJSON, _ = sjson.Set(newJSON, key, time.Now().UTC().Format(time.RFC3339))
               //fmt.Println(newJSON)
            case "uuid":
                newJSON, _= sjson.Set(newJSON, key , uuid.New().String())
            case "epoch":
                newJSON, _= sjson.Set(newJSON, key , time.Now().Unix())
            case "epochnano":
                newJSON, _= sjson.Set(newJSON, key , time.Now().UnixNano())
            case "promise_item":
                // first get the number of items to be added
                // between 1-10
                // get the 10 random int as item_id
                // get random boolean flag to set the origin_location or not
                type Location struct {
                    PostalCode string `json:"postal_code"`
                    Country    string `json:"country"`
                }
                
                type OriginLocation struct {
                    *Location
                    LocationId string `json:"location_id,omitempty"`
                }

                type ItemDetails struct {
                    Sku              string          `json:"sku"`
                    Quantity         *int            `json:"qty"`
                    ItemType         string          `json:"item_type"`
                    Origin           *OriginLocation `json:"origin,omitempty"`
                }
                numberOfItems := rand.Intn(5) + 1
                itemsSKU := []string{"195699503052","195699609860","194187346034","195699108141","195699659407","195699445536","194187259884","195699207257","194187449810","194187368647","195699422926","191743719141","195699357358","195699481664","192964264151","195699753914","194187666873","195699708990","195699283176","194187994341","195699457461","195699606555","195699792173","889833310759","195699435490","195699372047","194187433772","195699416406","192964086135","190696655544","195699614468","195699517813","195699758629","192964055513","195699100145","195699137684","195699617681","195699599635","195699575912","195699319622","195699654105","195699457164","195699634237","192964465664","195699547575","195699480117","195699314153","195699377837","195699564091","195699422551","194187977399","195699292864","195699649675","195699615274","195699566224","195699816572","195699928077","195699420953","195699057685","194187079703","192964455139","192964388567","195699943759","195699447387","195699443525","195699589346","195699487338","195699618039","195699455542","191743785795","195699621602","195699365506","194187690298","195699436190","195699519312","195699982192","195699056008","195699458123","889833522367","195699421103","195699610484","194187699611","195699389526","195699584402","195699586406","195699574632","196924018051","191743683725","195699249660","195699099593","195699006256","195699756717","195699444935","194187268183","194187944667","195699484979","195699636071","195699973244","195699940246","195699851009","195699463479","195699462328","194187630669","195699500341","194187369309","889833371637","195699610262","195699328600","195699157408","195699085312","195699795853","191743766992","195699752788","195699439184","195699424937","194187570231","195699323322","194187150532","195699424975","195699926332","195699892125","195699596948","195699797857","195699414662","194187833466","195699463288","195699417373","195699371934","194187538736","195699706804","195699999800","195699479791","194187761349","195699733954","195699612044","195699435469","195699551657","195699690363","195699425040","195699680395","195699594906","195699891449","194187826482","195699713017","889833508781","195699926455","195699149311","195699230477","195699847439","195699610125","195699648562","195699625198","195699425101","195699042155","195699039223","195699197558","194187911935","195699733992","195699377783","195699590908","194187806811","195699601352","195699783003","195699993815","195699796096","195699081000","195699710979","195699280922","195699723993","889833738515","195699394087","195699463820","192964083936","194187191115","196924002456","195699422360","195699594838","195699593961","195699622869","194187246044","195699326897","195699124912","195699288430","195699825994","195699414839","196924012257","195699762664","191743394355","195699979574","195699968912","195699518094","195699637948","195699021211","195699746381","195699054486","195699697836","196924016453","194187702465","195699545977","194187807856","195699581869","195699789555","192964748019","190696753509","195699440869","195699576803","195699409439","192964102378","195699436763","195699438637","195699531017","195699443075","196924003095","195699740471","195699562936","192964343412","195699736054","195699749986","194187463489","195699415997","194187110604","195699621848","194187150839","194187896645","192964651135","195699422070","195699426375","195699697393","195699615717","195699484283","195699627703","195699448285","195699806993","194187912789","191743913310","194187107079","191743321887","195699247895","194187936716","196924003705","195699450196","889833017122","194187939304","195699984578","194187972288","195699626003","195699605879","195699090958","194187370046","195699088504","194187971199","195699497320","195699318892","195699549456","195699613188","195699149113","195699899087","191743696466","195699248458","195699649330","195699179004","195699773516","195699711952","889833738188","195699752436","195699612037","195699129283","194187368609","195699056923","195699481121","195699696242","195699497221","195699970649","195699744646","195699663893","196924015739","194187801304","196924012264","190696657869","195699679597","195699399648","194187263447","192964094697","195699495098","195699579422","191743129612","192964388581","195699277342","194187164003","195699416369","195699632974","191743781643","195699607965","195699323575","195699750050","195699464285","195699429130","194187573935","195699309333","195699750104","190696752762","194187761370","195699425675","195699697966","194187547219","195699435223","195699707658","192964533493","195699891494","195699944688","195699366862","195699626256","194187392505","195699635036","195699732889","192964065475","195699731332","195699402997","195699789630","194187918378","192964735088","194187711528","195699984943","195699834149","195699430556","195699036765","195699705999","195699373723","195699563179","195699600485","194187843687","192964058477","194187446420","195699446120","195699029477","195699518117","195699659919","195699590083","196924017559","195699084124","190696313109","194187683450","195699659971","195699608917","194187245665","195699760233","194187855475","195699775947","195699624245","195699990333","192964204515","191743003776","194187836986","195699437043","195699337671","195699832022","195699083202","195699231245","194187729400","194187897024","191743862557","195699083363","195699607484","195699530720","195699309982","195699162860","192964027732","195699101197","195699764200","195699745001","195699384453","195699147805","195699856066","195699929159","195699641921","195699736962","195699642393","190696130980","191743289798","194187253424","192964055520","194187429584","195699619050","195699600195","195699580572","195699555129","190696706710","889833371620","195699455498","195699770447","194187821821","195699509573","195699164574","195699421813","194187975272","192964094642","195699291331","195699747395","195699450394","192964218550","195699089068","889833738522","195699708914","194187509781","195699238725","194187982591","195699825611","194187463588","195699333222","194187215668","195699703339","195699608344","191743688959","195699502024","195699609891","195699544062","195699912229","195699220157","195699378247","194187310783","195699663947","195699904507","195699763449","195699364400","195699789975","195699816497","195699847231","195699365643","191743853357","195699475410","194187730703","195699738461","195699764996","195699940666","195699150140","195699940468","195699483767","195699652699","195699806146","195699694774","196924014343","195699486454","195699921528","195699353442","195699970342","195699288287","195699280908","194187845957"}
                var items []ItemDetails
                for i := 0 ; i < numberOfItems; i++ {
                    itemId := rand.Intn(400) + 1
                    addOrigin := true
                    var origin *OriginLocation
                    if addOrigin {
                            origin = &OriginLocation{
                                Location: &Location{
                                    PostalCode: "89501",
                                    Country: "US",
                                },
                            }
                    }
                    quantity := rand.Intn(5) + 1
                    items = append(items, ItemDetails{
                        Sku: itemsSKU[itemId],
                        Quantity: &quantity,
                        ItemType: fmt.Sprintf("item_name_%d", itemId),
                        Origin:  origin,
                    })
                }

                newJSON, _ = sjson.Set(newJSON,key, items)
        }
    }
    return newJSON
}